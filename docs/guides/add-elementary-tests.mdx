---
title: "Add anomaly detection tests"
---

After you [install the dbt package](/quickstart#install-the-dbt-package) and related configuration, you can add Elementary data tests.

## Data monitors as dbt tests

Elementary is the first solution that delivers **data monitoring and anomaly detection as [dbt tests](https://docs.getdbt.com/docs/building-a-dbt-project/tests)**. Elementary dbt tests are actually data monitors that collect metrics and metadata over time. On each execution, the tests analyze the new data, compare it to historical metrics, and alert on anomalies and outliers.
These tests are configured and executed like any other tests in your project.

_Note_: Anomaly detection is not yet supported on Databricks in dbt Cloud.

<Info>
  Elementary tests can only be used with the elementary models, so you must run
  "dbt run --select elementary" to create the Elementary package models.
</Info>

## Elementary available monitors as tests

### Table (model / source) tests:

<Accordion title="elementary.volume">

`elementary.volume`

Monitors the row count of your table.

<CodeGroup>

```yml Models
version: 2

models:
  - name: < model name >
    tests:
      - elementary.volume:
          timestamp_column: < timestamp column >
          where_expression: < sql expression >
```

```yml Models example
version: 2

models:
  - name: login_events
    config:
      elementary:
        timestamp_column: 'loaded_at'
    tests:
      - elementary.volume:
          where_expression: "event_type in ('event_1', 'event_2') and country_name != 'unwanted country'"
          # optional - use tags to run elementary tests on a dedicated run
          tags: ['elementary']
          config:
          # optional - change severity
            severity: warn

  - name: users
    ## if no timestamp is configured, elementary will monitor without time filtering
    tests:
      - elementary.volume:
          tags: ['elementary']
```

</CodeGroup>

</Accordion>

<Accordion title="elementary.freshness">

`elementary.volume`

Monitors the freshness of your table.

<CodeGroup>

```yml Models
version: 2

models:
  - name: < model name >
    tests:
      - elementary.freshness:
          timestamp_column: < timestamp column >
          where_expression: < sql expression >
```

```yml Models example
version: 2

models:
  - name: login_events
    tests:
      - elementary.freshness:
          timestamp_column: 'loaded_at'
          # optional - use tags to run elementary tests on a dedicated run
          tags: ['elementary']
          config:
          # optional - change severity
            severity: warn
```

</CodeGroup>

</Accordion>

<Accordion title="elementary.table_anomalies">

`elementary.table_anomalies`

Executes table level monitors and anomaly detection. Specific monitors are [detailed here](/data-anomaly-detection#tests-and-monitors-types) and can be configured using the `table_anomalies` key.
By default, the freshness test will use the `timestamp_column` provided. If you need to test for freshness by another column (e.g. if your table is partitioned), add the key `freshness_column` to the test.

<CodeGroup>

```yml Models
version: 2

models:
  - name: < model name >
    config:
      elementary:
        timestamp_column: < timestamp column >
    tests:
      - elementary.table_anomalies:
          table_anomalies: < specific monitors, all if null >
          # optional - configure different freshness column than timestamp column
          freshness_column: < freshness_column >
          where_expression: < sql expression >
```

```yml Models example
version: 2

models:
  - name: login_events
    config:
      elementary:
        timestamp_column: 'loaded_at'
    tests:
      - elementary.table_anomalies:
          table_anomalies:
            - row_count
            - freshness
          where_expression: "event_type in ('event_1', 'event_2') and country_name != 'unwanted country'"
          # optional - use tags to run elementary tests on a dedicated run
          tags: ['elementary']
          config:
          # optional - change severity
            severity: warn

  - name: users
    ## if no timestamp is configured, elementary will monitor without time filtering
    tests:
      - elementary.table_anomalies:
          tags: ['elementary']
```

</CodeGroup>

</Accordion>

<Accordion title="elementary.dimension_anomalies">

`elementary.dimension_anomalies`

This test monitors the frequency of values in the configured dimension over time, and alerts on unexpected changes in the distribution.
It is best to configure it on low-cardinality fields.
The test counts rows grouped by given columns/expressions, and can be configured using the `dimensions` and `where_expression` keys.

<CodeGroup>

```yml Models
version: 2

models:
  - name: < model name >
    config:
      elementary:
        timestamp_column: < timestamp column >
    tests:
      - elementary.dimension_anomalies:
          dimensions: < columns or sql expressions of columns >
          # optional - configure a where a expression to accurate the dimension monitoring
          where_expression: < sql expression >
```

```yml Models example
version: 2

models:
  - name: login_events
    config:
      elementary:
        timestamp_column: "loaded_at"
    tests:
      - elementary.dimension_anomalies:
          dimensions:
            - event_type
            - country_name
          where_expression: "event_type in ('event_1', 'event_2') and country_name != 'unwanted country'"
          # optional - use tags to run elementary tests on a dedicated run
          tags: ["elementary"]
          config:
            # optional - change severity
            severity: warn

  - name: users
    ## if no timestamp is configured, elementary will monitor without time filtering
    tests:
      - elementary.dimension_anomalies:
          dimensions:
            - event_type
          tags: ["elementary"]
```

</CodeGroup>

</Accordion>

<Accordion title="elementary.all_columns_anomalies">

`elementary.all_columns_anomalies`

Executes column level monitors and anomaly detection on all the columns of the table. Specific monitors are [detailed here](/guides/data-anomaly-detection#tests-and-monitors-types) and can be configured using the `all_columns_anomalies` key.

<CodeGroup>

```yml Models
version: 2

models:
  - name: < model name >
    config:
      elementary:
        timestamp_column: < timestamp column >
    tests:
      - elementary.all_columns_anomalies:
          column_anomalies: < specific monitors, all if null >
          where_expression: < sql expression >
```

```yml Models example
version: 2

models:
  - name: login_events
    config:
      elementary:
        timestamp_column: "loaded_at"
    tests:
      - elementary.all_columns_anomalies:
          where_expression: "event_type in ('event_1', 'event_2') and country_name != 'unwanted country'"
          tags: ["elementary"]
          # optional - change global sensitivity
          sensitivity: 3.5
```

</CodeGroup>

</Accordion>

<Accordion title="elementary.schema_changes">

`elementary.schema_changes`

Executes schema changes monitor that alerts on deleted table, deleted or added columns, or change of data type of a column.

_Not supported in Databricks._

<CodeGroup>

```yml Models
version: 2

models:
  - name: < model name >
    config:
      elementary:
        timestamp_column: < timestamp column >
    tests:
      - elementary.schema_changes
```

```yml Models example
version: 2

models:
  - name: login_events
    config:
      elementary:
        timestamp_column: "loaded_at"
    tests:
      - elementary.schema_changes:
          tags: ["elementary"]
          config:
            severity: warn
```

</CodeGroup>

</Accordion>

<Accordion title="elementary.schema_changes_from_baseline">

`elementary.schema_changes_from_baseline`

Checks for schema changes against baseline columns defined in a source's or model's configuration.
For this test to work, the configuration should contain columns and data types.

The initial configuration needed for this test to work can be auto-generated (see details below).

Supported parameters for the test:
* `fail_on_added` - If set, the test will fail if there are columns in the table that do not exist in the baseline (default:
False - meaning added columns won't cause the test to fail).
* `enforce_types` - If set, the test will raise an error if there are columns that are defined without a data type (default:
False - in this case the test will not fail, but instead will only verify that the column exists and not its type)

_Not supported in Databricks._

<Accordion title="How to auto-generate the baseline">

In order for the schema changes from baseline test to work, a baseline needs to be generated from an initial state of
the table and and it should be added to the configuration of the source / model under "columns". The baseline consists
of the name and data type for each column.

In order to generate the baseline, Elementary provides the `generate_schema_baseline_test` macro. By default,
running it will generate a schema_changes_from_baseline test for all sources, but it can be customized with
the following arguments:
* `name` - run on a specific source / model
* `include_models` - whether or not to generate tests for models (default - false)
* `include_sources` - whether or not to generate tests for sources (default - true)
* `fail_on_added` - if set, the "fail_on_added" parameter will be added to the configuration of the tests with the supplied setting
* `enforce_types` - if set, the "enforce_types" parameter will be added to the configuration of the tests with the supplied setting

Examples:
```shell
# Generate a schema changes from baseline test for all sources
dbt run-operation elementary.generate_schema_baseline_test

# Generate a schema changes from baseline test for a specific model / source named "orders"
dbt run-operation elementary.generate_schema_baseline_test --args '{"name": "orders"}'

# Generate a schema changes from baseline test for all sources and all models
dbt run-operation elementary.generate_schema_baseline_test --args '{"include_models": true}'

# Generate a schema changes from baseline test with the "fail_on_added" and "enforce_types" parameters set to true
dbt run-operation elementary.generate_schema_baseline_test --args '{"fail_on_added": true, "enforce_types": true}'
```

</Accordion>

<CodeGroup>

```yml Sources
version: 2

sources:
  - name: < source name >
    database: < database name >
    schema: < schema name >
    tables:
      - name: < table name >
        columns:
          - name: < column 1 >
            data_type: < data type 1 >
          - name: < column 2 >
            data_type: < data type 2 >
        tests:
          - elementary.schema_changes_from_baseline
```

```yml Sources example
version: 2

sources:
  - name: 'my_non_dbt_data'
    database: 'raw_events'
    schema: 'product'
    tables:
      - name: 'raw_product_login_events'
        columns:
          - name: event_name
            data_type: text
          - name: event_id
            data_type: integer
        tests:
          - elementary.schema_changes_from_baseline
              tags: ["elementary"]
```

```yml Models
version: 2

models:
  - name: < model name >
    columns:
      - name: < column 1 >
        data_type: < data type 1 >
      - name: < column 2 >
        data_type: < data type 1 >
    tests:
      - elementary.schema_changes_from_baseline
```

```yml Models example
version: 2

models:
  - name: login_events
    columns:
      - name: event_name
        data_type: text
      - name: event_id
        data_type: integer
    tests:
      - elementary.schema_changes_from_baseline:
          tags: ["elementary"]
```

</CodeGroup>

</Accordion>

### Column test:

<Accordion title="elementary.column_anomalies">

`elementary.column_anomalies`

Executes column level monitors and anomaly detection. Specific monitors are [detailed here](/guides/data-anomaly-detection#tests-and-monitors-types) and can be configured using the `column_anomalies` key.

<CodeGroup>

```yml Models
version: 2

models:
  - name: < model name >
    config:
      elementary:
        timestamp_column: < timestamp column >
     columns:
      - name: < column name >
        tests:
          - elementary.column_anomalies:
              column_anomalies: < specific monitors, all if null >

  - name: < model name >
    ## if no timestamp is configured, elementary will monitor without time filtering
    columns:
      - name: < column name >
        tests:
          - elementary.column_anomalies:
              column_anomalies: < specific monitors, all if null >
              where_expression: < sql expression >
```

```yml Models example
version: 2

models:
  - name: login_events
    config:
      elementary:
        timestamp_column: 'loaded_at'
    columns:
      - name: user_name
        tests:
          - elementary.column_anomalies:
              column_anomalies:
                - missing_count
                - min_length
              where_expression: "event_type in ('event_1', 'event_2') and country_name != 'unwanted country'"
              tags: ['elementary']

  - name: users
    ## if no timestamp is configured, elementary will monitor without time filtering
    tests:
        elementary.table_anomalies
          tags: ['elementary']
    columns:
      - name: user_id
        tests:
          - elementary.column_anomalies:
              tags: ['elementary']
              timestamp_column: 'updated_at'
              where_expression: "event_type in ('event_1', 'event_2') and country_name != 'unwanted country'"
      - name: user_name
        tests:
          - elementary.column_anomalies:
              column_anomalies:
                - missing_count
                - min_length
              tags: ['elementary']
```

</CodeGroup>

</Accordion>

## How to configure your Elementary tests?

Elementary tests are added to models / sources / columns of your dbt project just like the native dbt tests. You can configure specific monitors under the relevant keys (otherwise all relevant monitors will run).

Elementary tests have three levels of configurations:

1. [Test arguments](/guides/elementary-tests-configuration#test-arguments) - Test specific arguments.
2. Table configuration - Configure the timestamp column and details of a monitored table.
3. [Global vars](/guides/elementary-tests-configuration#data-monitoring-global-vars) - Optional configuration parameters of the operation.

More on data tests configuration [here](/guides/elementary-tests-configuration).

We recommend adding a tag to the tests so you could execute these in a dedicated run using the selection parameter `--select tag:elementary`.
If you wish to only be warned on anomalies, configure the severity of the tests to warn.

<CodeGroup>

```yml Models
version: 2

models:
  - name: < model name >
    config:
      elementary:
        timestamp_column: < timestamp column >
    tests:
      - elementary.table_anomalies:
          table_anomalies: < specific monitors, all if null >
          # optional - configure different freshness column than timestamp column
          freshness_column: < freshness_column >
      - elementary.all_columns_anomalies:
          column_anomalies: < specific monitors, all if null >
      - elementary.schema_changes
      - elementary.dimension_anomalies:
          dimensions: < columns or sql expressions of columns >
          # optional - configure a where a expression to accurate the dimension monitoring
          where_expression: < sql expression >

  - name: < model name >
    ## if no timestamp is configured, elementary will monitor without time filtering
    columns:
      - name: < column name >
        tests:
          - elementary.column_anomalies:
              column_anomalies: < specific monitors, all if null >
```

```yml Models example
version: 2

models:
  - name: login_events
    config:
      elementary:
        timestamp_column: 'loaded_at'
    tests:
        - elementary.table_anomalies:
            table_anomalies:
              - row_count
              - freshness
            # optional - use tags to run elementary tests on a dedicated run
            tags: ['elementary']
            config:
            # optional - change severity
              severity: warn
        - elementary.all_columns_anomalies:
            tags: ['elementary']
            # optional - change global sensitivity
            sensitivity: 3.5
            timestamp_column: 'updated_at'
        - elementary.schema_changes:
            tags: ['elementary']
            config:
              severity: warn
        - elementary.dimension_anomalies:
            dimensions:
              - event_type
              - country_name
            where_expression: "event_type in ('event_1', 'event_2') and country_name != 'unwanted country'"
            # optional - use tags to run elementary tests on a dedicated run
            tags: ['elementary']
            config:
            # optional - change severity
              severity: warn

  - name: users
    ## if no timestamp is configured, elementary will monitor without time filtering
    tests:
        elementary.table_anomalies
          tags: ['elementary']
    columns:
      - name: user_id
        tests:
          - elementary.column_anomalies:
              tags: ['elementary']
              timestamp_column: 'updated_at'
      - name: user_name
        tests:
          - elementary.column_anomalies:
              column_anomalies:
                - missing_count
                - min_length
              tags: ['elementary']
```

```yml Sources
sources:
  - name: < some name >
    database: < datatbase >
    schema: < schema >
    tables:
      - name: < table_name >
        ## sources don't have config, so elementary config is placed under 'meta'
        meta:
          elementary:
            timestamp_column: < source timestamp column >
        tests: <here you will add elementary monitors as tests>
```

```yml Sources example
sources:
  - name: 'my_non_dbt_data'
    database: 'raw_events'
    schema: 'product'
    tables:
      - name: 'raw_product_login_events'
      ## sources don't have config, so elementary config is placed under 'meta'
        meta:
          elementary:
            timestamp_column: 'loaded_at'
        tests:
          - elementary.table_anomalies
          - elementary.dimension_anomalies:
              dimensions:
                - event_type
          - elementary.all_columns_anomalies:
              column_anomalies:
                - null_count
                - missing_count
                - zero_count
          - elementary.schema_changes_from_baseline
        columns:
          - name: user_id
            data_type: text
            tests:
              - elementary.column_anomalies
          - name: event_name
            data_type: text
          - name: event_id
            data_type: integer
```

</CodeGroup>

## What happens on each test?

On each test elementary package executes the relevant monitors, and searches for anomalies by comparing to historical metrics.
At the end of the `dbt test` run, all results and collected metrics are merged into the elementary models.

## What does it mean when a test fails?

When a test fail, it means that an anomaly was detected on this metric and dataset. To learn more, refer to [anomaly detection](/guides/data-anomaly-detection#anomaly-detection).

## Where are Elementary tests results stored?

At the end of the `dbt test` run, all results and collected metrics are merged into the elementary models. The relevant models are:

- `alerts_data_monitoring` - All the detected anomalies are merged to this table.
- `data_monitoring_metrics` - All the collected metrics are merged to this table.
- `metrics_anomaly_score` - The anomaly score calculated for all the metrics from the last 7 days.

## Alerts on detected anomalies (failed tests)

To get Slack notifications, refer to the [Slack integration](/integrations/slack).
